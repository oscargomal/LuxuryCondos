<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Departamentos | Luxury Condo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

  <aside class="sidebar">
    <h2>Luxury Condo</h2>
    <nav>
      <a href="admin.html">Dashboard</a>
      <a href="reservaciones.html">Reservaciones</a>
      <a href="rooms.html" class="active">Departamentos</a>
      <a href="avisos.html">Avisos</a>
      <a href="clientes.html">Clientes</a>
      <a href="reportes.html">Reportes</a>

      <a href="index.html" class="logout" data-logout>Cerrar sesión</a>
    </nav>
  </aside>

  <main class="main">
    <header class="header">
      <div class="header-meta">
        <h1>Departamentos</h1>
        <span>Gestiona lo que se muestra en Departamentos</span>
      </div>
      <button class="btn btn-primary" type="button" id="toggleRoomForm" aria-expanded="false">
        Nuevo departamento
      </button>
    </header>

    <section class="form-card" id="stripeConnectCard">
      <h2>Stripe Connect</h2>
      <p id="stripeConnectStatus">No conectado</p>
      <div class="form-group">
        <button class="btn btn-primary" type="button" id="stripeConnectButton">
          Conectar Stripe / Generar enlace de conexión
        </button>
        <button class="btn btn-warning btn-small" type="button" id="stripeConnectEdit">
          Editar acct_...
        </button>
      </div>
      <div class="form-group" id="stripeConnectEditGroup" hidden>
        <input type="text" id="stripeConnectInput" placeholder="acct_1234567890">
        <button class="btn btn-primary" type="button" id="stripeConnectSave">Guardar acct_...</button>
      </div>
    </section>

    <section class="form-card is-hidden" data-form-card>
      <h2 data-form-title>Nuevo departamento</h2>
      <form id="roomForm">
        <div class="form-group">
          <label>Nombre</label>
          <input type="text" id="roomName" placeholder="Vista al Lago" required>
        </div>

        <div class="form-group">
          <label>Resumen corto</label>
          <input type="text" id="roomSummary" placeholder="2 huéspedes · Balcón · Cama King">
        </div>

        <div class="form-group">
          <label>Descripción</label>
          <textarea id="roomDescription" rows="4" placeholder="Describe el departamento..."></textarea>
        </div>

        <div class="form-group">
          <label>Precio por noche (MXN)</label>
          <input type="number" id="roomPrice" placeholder="3000" min="0">
        </div>

        <div class="form-group">
          <label>Precio mensual (MXN)</label>
          <input type="number" id="roomPriceMonth" placeholder="33000" min="0">
        </div>

        <div class="form-group">
          <label>Precio anual (MXN)</label>
          <input type="number" id="roomPriceYear" placeholder="31000" min="0">
        </div>

        <div class="form-group">
          <label>Imágenes (URLs separadas por coma)</label>
          <textarea id="roomImages" rows="3" placeholder="https://.../1.jpg, https://.../2.jpg"></textarea>
        </div>

        <div class="form-group">
          <label>Subir imágenes</label>
          <input type="file" id="roomImageFiles" accept="image/*" multiple>
          <small class="form-hint">Se suben a Supabase Storage automáticamente.</small>
        </div>

        <div class="form-group">
          <label>Vista previa</label>
          <div class="image-preview" id="roomImagePreview"></div>
        </div>

        <div class="form-group">
          <label>Activo</label>
          <select id="roomActive">
            <option value="true" selected>Sí</option>
            <option value="false">No</option>
          </select>
        </div>

        <div class="form-group">
          <label>Ocupado</label>
          <select id="roomOccupied">
            <option value="false" selected>No</option>
            <option value="true">Sí</option>
          </select>
        </div>

        <button class="btn btn-primary" type="submit" id="roomSubmit">Guardar</button>
      </form>
    </section>

    <section class="table-section">
      <h2>Listado de departamentos</h2>
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Precio</th>
            <th>Mensual</th>
            <th>Anual</th>
            <th>Activo</th>
            <th>Ocupado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="roomTableBody">
          <tr>
            <td colspan="7">No hay departamentos registrados.</td>
          </tr>
        </tbody>
      </table>
    </section>
  </main>

  <script>
    const API_URL = "/api/rooms";
    const form = document.getElementById("roomForm");
    const nameInput = document.getElementById("roomName");
    const summaryInput = document.getElementById("roomSummary");
    const descriptionInput = document.getElementById("roomDescription");
    const priceInput = document.getElementById("roomPrice");
    const priceMonthInput = document.getElementById("roomPriceMonth");
    const priceYearInput = document.getElementById("roomPriceYear");
    const imagesInput = document.getElementById("roomImages");
    const imageFilesInput = document.getElementById("roomImageFiles");
    const imagePreview = document.getElementById("roomImagePreview");
    const activeInput = document.getElementById("roomActive");
    const occupiedInput = document.getElementById("roomOccupied");
    const submitButton = document.getElementById("roomSubmit");
    const tableBody = document.getElementById("roomTableBody");
    const toggleButton = document.getElementById("toggleRoomForm");
    const formCard = document.querySelector("[data-form-card]");
    const formTitle = document.querySelector("[data-form-title]");
    const stripeConnectStatus = document.getElementById("stripeConnectStatus");
    const stripeConnectButton = document.getElementById("stripeConnectButton");
    const stripeConnectEdit = document.getElementById("stripeConnectEdit");
    const stripeConnectEditGroup = document.getElementById("stripeConnectEditGroup");
    const stripeConnectInput = document.getElementById("stripeConnectInput");
    const stripeConnectSave = document.getElementById("stripeConnectSave");

    let editingId = null;
    let urlImages = [];
    let uploadedImages = [];
    let roomsCache = [];

    const parseImages = (value) => {
      if (!value) return [];
      return value
        .split(",")
        .map((item) => item.trim())
        .filter(Boolean);
    };

    const formatMoney = (value) => {
      const numberValue = Number(value || 0);
      if (!numberValue) return "—";
      return `$${numberValue.toLocaleString()} MXN`;
    };

    const isStripeAccountId = (value) => /^acct_[A-Za-z0-9]+$/.test(value);

    const setFormVisible = (visible) => {
      if (!formCard || !toggleButton) return;
      formCard.classList.toggle("is-hidden", !visible);
      toggleButton.textContent = visible ? "Cerrar" : "Nuevo departamento";
      toggleButton.setAttribute("aria-expanded", String(visible));
    };

    const splitImages = (images) => {
      const urls = [];
      const uploads = [];
      (images || []).forEach((img) => {
        if (!img) return;
        if (img.startsWith("data:")) {
          uploads.push(img);
        } else {
          urls.push(img);
        }
      });
      return { urls, uploads };
    };

    const renderPreview = () => {
      if (!imagePreview) return;
      const items = [
        ...urlImages.map((src, index) => ({ src, source: "url", index })),
        ...uploadedImages.map((src, index) => ({ src, source: "upload", index }))
      ];

      if (!items.length) {
        imagePreview.innerHTML = "<span class=\"image-preview__empty\">Sin imágenes</span>";
        return;
      }

      imagePreview.innerHTML = "";
      items.forEach((item) => {
        const wrapper = document.createElement("div");
        wrapper.className = "image-preview__item";
        wrapper.innerHTML = `
          <img src="${item.src}" alt="Vista previa">
          <button class="image-preview__remove" type="button" data-remove="true" data-source="${item.source}" data-index="${item.index}">×</button>
        `;
        imagePreview.appendChild(wrapper);
      });
    };

    const readFileAsDataUrl = (file) => (
      new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(file);
      })
    );

    const uploadRoomImage = async (dataUrl, fileName) => {
      const response = await fetch("/api/upload-room-image", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ dataUrl, fileName })
      });
      const result = await response.json().catch(() => ({}));
      if (!response.ok) {
        throw new Error(result?.error || "No se pudo subir la imagen.");
      }
      return result?.publicUrl || result?.path || "";
    };

    const fetchRooms = async () => {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) return [];
        const result = await response.json();
        return result?.data || [];
      } catch (error) {
        return [];
      }
    };

    const saveRoom = async (payload) => {
      const method = editingId ? "PUT" : "POST";
      const body = editingId ? { ...payload, id: editingId } : payload;
      const response = await fetch(API_URL, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      return response.ok;
    };

    const deleteRoom = async (id) => {
      const response = await fetch(API_URL, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });
      return response.ok;
    };

    const updateRoomOccupancy = async (id, occupied) => {
      const response = await fetch(API_URL, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, occupied })
      });
      return response.ok;
    };

    const fillForm = (room) => {
      editingId = room.id;
      nameInput.value = room.name || "";
      summaryInput.value = room.summary || "";
      descriptionInput.value = room.description || "";
      priceInput.value = room.price_night || "";
      priceMonthInput.value = room.price_month || "";
      priceYearInput.value = room.price_year || "";
      const split = splitImages(room.images || []);
      urlImages = split.urls;
      uploadedImages = split.uploads;
      imagesInput.value = urlImages.join(", ");
      activeInput.value = String(room.is_active);
      occupiedInput.value = String(room.occupied);
      submitButton.textContent = "Actualizar";
      if (formTitle) formTitle.textContent = "Editar departamento";
      if (imageFilesInput) imageFilesInput.value = "";
      renderPreview();
      setFormVisible(true);
      form.scrollIntoView({ behavior: "smooth" });
    };

    const resetForm = () => {
      editingId = null;
      form.reset();
      submitButton.textContent = "Guardar";
      urlImages = [];
      uploadedImages = [];
      if (formTitle) formTitle.textContent = "Nuevo departamento";
      if (imageFilesInput) imageFilesInput.value = "";
      renderPreview();
    };

    const renderTable = (rooms) => {
      if (!tableBody) return;
      tableBody.innerHTML = "";

      if (!rooms.length) {
        tableBody.innerHTML = "<tr><td colspan=\"7\">No hay departamentos registrados.</td></tr>";
        return;
      }

      rooms.forEach((room) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${room.name || "—"}</td>
          <td>${formatMoney(room.price_night)}</td>
          <td>${formatMoney(room.price_month)}</td>
          <td>${formatMoney(room.price_year)}</td>
          <td>${room.is_active ? "Sí" : "No"}</td>
          <td>${room.occupied ? "Sí" : "No"}</td>
          <td>
            <button class="btn btn-info btn-small" data-action="toggle-occupied" data-id="${room.id}">
              ${room.occupied ? "Liberar" : "Bloquear"}
            </button>
            <button class="btn btn-warning btn-small" data-action="edit" data-id="${room.id}">Editar</button>
            <button class="btn btn-danger btn-small" data-action="delete" data-id="${room.id}">Eliminar</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    };

    const loadRooms = async () => {
      const rooms = await fetchRooms();
      roomsCache = rooms;
      renderTable(rooms);
    };

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      urlImages = parseImages(imagesInput.value);
      const images = [...new Set([...urlImages, ...uploadedImages])];
      const payload = {
        name: nameInput.value.trim(),
        summary: summaryInput.value.trim(),
        description: descriptionInput.value.trim(),
        price_night: Number(priceInput.value || 0),
        price_month: priceMonthInput.value ? Number(priceMonthInput.value) : null,
        price_year: priceYearInput.value ? Number(priceYearInput.value) : null,
        images,
        is_active: activeInput.value === "true",
        occupied: occupiedInput.value === "true"
      };

      const ok = await saveRoom(payload);
      if (ok) {
        resetForm();
        loadRooms();
      } else {
        alert("No se pudo guardar el departamento.");
      }
    });

    tableBody.addEventListener("click", async (event) => {
      const button = event.target.closest("[data-action]");
      if (!button) return;

      const id = button.dataset.id;
      if (button.dataset.action === "delete") {
        const ok = await deleteRoom(id);
        if (ok) {
          loadRooms();
        } else {
          alert("No se pudo eliminar.");
        }
      }

      if (button.dataset.action === "toggle-occupied") {
        const room = roomsCache.find((item) => String(item.id) === String(id));
        if (!room) return;
        const ok = await updateRoomOccupancy(id, !room.occupied);
        if (ok) {
          loadRooms();
        } else {
          alert("No se pudo actualizar la ocupación.");
        }
      }

      if (button.dataset.action === "edit") {
        const rooms = await fetchRooms();
        const room = rooms.find((item) => String(item.id) === String(id));
        if (room) fillForm(room);
      }
    });

    if (imagesInput) {
      imagesInput.addEventListener("input", () => {
        urlImages = parseImages(imagesInput.value);
        renderPreview();
      });
    }

    if (imageFilesInput) {
      imageFilesInput.addEventListener("change", async (event) => {
        const files = Array.from(event.target.files || []);
        if (!files.length) return;
        imageFilesInput.disabled = true;
        try {
          const uploads = await Promise.all(files.map(async (file) => {
            const dataUrl = await readFileAsDataUrl(file);
            return await uploadRoomImage(dataUrl, file.name || "room-image");
          }));
          uploadedImages = [...uploadedImages, ...uploads].filter(Boolean);
          renderPreview();
        } catch (error) {
          alert(error.message || "Error subiendo imágenes.");
        } finally {
          imageFilesInput.disabled = false;
          imageFilesInput.value = "";
        }
      });
    }

    if (imagePreview) {
      imagePreview.addEventListener("click", (event) => {
        const button = event.target.closest("[data-remove]");
        if (!button) return;
        const source = button.dataset.source;
        const index = Number(button.dataset.index);
        if (source === "url") {
          urlImages.splice(index, 1);
          imagesInput.value = urlImages.join(", ");
        } else {
          uploadedImages.splice(index, 1);
        }
        renderPreview();
      });
    }

    if (toggleButton) {
      toggleButton.addEventListener("click", () => {
        const shouldOpen = formCard?.classList.contains("is-hidden");
        if (shouldOpen) {
          setFormVisible(true);
          renderPreview();
        } else {
          resetForm();
          setFormVisible(false);
        }
      });
    }

    const setStripeConnectStatus = (accountId) => {
      if (stripeConnectStatus) {
        stripeConnectStatus.textContent = accountId
          ? `Conectado: ${accountId}`
          : "No conectado";
      }
      if (stripeConnectInput) stripeConnectInput.value = accountId || "";
    };

    const loadStripeConnectStatus = async () => {
      try {
        const response = await fetch("/api/connect-account");
        const result = await response.json();
        if (!response.ok) throw new Error(result?.error || "No disponible.");
        setStripeConnectStatus(result?.stripeAccountId || "");
      } catch (error) {
        setStripeConnectStatus("");
      }
    };

    if (stripeConnectButton) {
      stripeConnectButton.addEventListener("click", async () => {
        stripeConnectButton.disabled = true;
        try {
          const response = await fetch("/api/connect-account", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({})
          });

          const result = await response.json();
          if (!response.ok) {
            throw new Error(result?.error || "No se pudo generar el enlace.");
          }

          setStripeConnectStatus(result.accountId || "");
          if (result.url) window.open(result.url, "_blank", "noopener");
        } catch (error) {
          alert(error.message || "Error conectando Stripe.");
        } finally {
          stripeConnectButton.disabled = false;
        }
      });
    }

    if (stripeConnectEdit && stripeConnectEditGroup) {
      stripeConnectEdit.addEventListener("click", () => {
        stripeConnectEditGroup.hidden = !stripeConnectEditGroup.hidden;
      });
    }

    if (stripeConnectSave) {
      stripeConnectSave.addEventListener("click", async () => {
        const value = stripeConnectInput?.value.trim() || "";
        if (value && !isStripeAccountId(value)) {
          alert("El ID de Stripe debe empezar con acct_ y contener solo letras y números.");
          return;
        }

        stripeConnectSave.disabled = true;
        try {
          const response = await fetch("/api/connect-account", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ stripeAccountId: value || null })
          });

          const result = await response.json();
          if (!response.ok) {
            throw new Error(result?.error || "No se pudo guardar el ID.");
          }

          setStripeConnectStatus(result.accountId || "");
          if (stripeConnectEditGroup) stripeConnectEditGroup.hidden = true;
        } catch (error) {
          alert(error.message || "Error guardando el ID.");
        } finally {
          stripeConnectSave.disabled = false;
        }
      });
    }

    setFormVisible(false);
    loadRooms();
    loadStripeConnectStatus();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/admin/js/auth.js"></script>
</body>
</html>
