<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reportes | Luxury Condo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/reportes.css">
  <link rel="stylesheet" href="css/admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

  <aside class="sidebar">
    <h2>Luxury Condo</h2>
    <nav>
      <a href="admin.html" class="active">Dashboard</a>
      <a href="reservaciones.html">Reservaciones</a>
      <a href="rooms.html">Departamentos</a>
      <a href="avisos.html">Avisos</a>
      <a href="clientes.html">Clientes</a>
      <a href="reportes.html">Reportes</a>

      <a href="index.html" class="logout">Cerrar sesión</a>
    </nav>
  </aside>

  <main class="main">

    <header class="header">
      <h1>Reportes</h1>
    </header>

    <section class="form-card">
      <h2>Filtrar por fecha</h2>

      <div class="filters">
        <div class="form-group">
          <label>Desde</label>
          <input type="date">
        </div>

        <div class="form-group">
          <label>Hasta</label>
          <input type="date">
        </div>

        <button class="btn btn-primary">Generar reporte</button>
      </div>
    </section>

    <section class="cards">
      <div class="card">
        <h3>Total reservaciones</h3>
        <p data-report="total">0</p>
      </div>

      <div class="card">
        <h3>Ingresos estimados</h3>
        <p data-report="revenue">—</p>
      </div>

      <div class="card">
        <h3>Ocupación promedio</h3>
        <p data-report="occupancy">—</p>
      </div>
    </section>

  </main>

  <script>
    const STORAGE_KEY = "luxuryReservations";
    const TOTAL_ROOMS = 12;

    const readReservations = () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (error) {
        return [];
      }
    };

    const parseMoney = (value) => {
      if (!value) return 0;
      const numeric = String(value).replace(/[^0-9]/g, "");
      return numeric ? Number(numeric) : 0;
    };

    const totalEl = document.querySelector('[data-report="total"]');
    const revenueEl = document.querySelector('[data-report="revenue"]');
    const occupancyEl = document.querySelector('[data-report="occupancy"]');

    const normalizeReservation = (reservation) => {
      if (reservation?.guest) return reservation;
      return {
        room: { name: reservation?.room_name || "—" },
        total: reservation?.total,
        status: reservation?.status,
        paymentStatus: reservation?.payment_status
      };
    };

    const fetchReservations = async () => {
      try {
        const response = await fetch("/api/reservations");
        if (!response.ok) return null;
        const result = await response.json();
        return result?.data || null;
      } catch (error) {
        return null;
      }
    };

    const renderReport = (rawReservations) => {
      const reservations = rawReservations.map(normalizeReservation);
      const paidReservations = reservations.filter((reservation) => (
        reservation?.paymentStatus === "paid" || reservation?.status === "Confirmada"
      ));
      const revenue = paidReservations.reduce((sum, reservation) => (
        sum + parseMoney(reservation?.total)
      ), 0);
      const occupiedRooms = new Set(
        paidReservations
          .map((reservation) => reservation?.room?.name)
          .filter(Boolean)
      ).size;
      const occupancyRate = TOTAL_ROOMS
        ? Math.round((occupiedRooms / TOTAL_ROOMS) * 100)
        : 0;

      if (totalEl) totalEl.textContent = String(reservations.length);
      if (revenueEl) {
        revenueEl.textContent = revenue
          ? `$${revenue.toLocaleString()}`
          : "—";
      }
      if (occupancyEl) {
        occupancyEl.textContent = `${occupancyRate}%`;
      }
    };

    const loadReport = async () => {
      const apiReservations = await fetchReservations();
      if (apiReservations && apiReservations.length) {
        renderReport(apiReservations);
        return;
      }
      renderReport(readReservations());
    };

    loadReport();
  </script>
</body>
</html>

