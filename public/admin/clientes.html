<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Clientes | Luxury Condo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/clientes.css">
  <link rel="stylesheet" href="css/admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

  <aside class="sidebar">
    <h2>Luxury Condo</h2>
    <nav>
      <a href="admin.html" class="active">Dashboard</a>
      <a href="reservaciones.html">Reservaciones</a>
      <a href="rooms.html">Departamentos</a>
      <a href="avisos.html">Avisos</a>
      <a href="clientes.html">Clientes</a>
      <a href="reportes.html">Reportes</a>

      <a href="index.html" class="logout" data-logout>Cerrar sesión</a>
    </nav>
  </aside>

  <main class="main">

    <header class="header">
      <h1>Clientes</h1>
    </header>

    <section class="table-section">
      <h2>Clientes registrados</h2>

      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Teléfono</th>
            <th>Reservaciones</th>
            <th>ID frente</th>
            <th>ID reverso</th>
            <th>Acciones</th>
          </tr>
        </thead>

        <tbody id="clientTableBody">
          <tr>
            <td colspan="7">No hay clientes registrados.</td>
          </tr>
        </tbody>
      </table>
    </section>

  </main>

  <script>
    const STORAGE_KEY = "luxuryReservations";
    const tableBody = document.getElementById("clientTableBody");

    const readReservations = () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (error) {
        return [];
      }
    };

    const normalizeReservation = (reservation) => {
      if (reservation?.guest) return reservation;
      const guestSnapshot = reservation?.guest_snapshot || {};
      return {
        guest: {
          name: reservation?.guest_name || guestSnapshot?.name || "—",
          email: reservation?.guest_email || guestSnapshot?.email || "—",
          phone: reservation?.guest_phone || guestSnapshot?.phone || "—",
          idPhotoFront: guestSnapshot?.idPhotoFront || null,
          idPhotoBack: guestSnapshot?.idPhotoBack || null
        }
      };
    };

    const buildClientMap = (reservationsRaw) => {
      const reservations = reservationsRaw.map(normalizeReservation);
      const clientMap = new Map();

      reservations.forEach((reservation) => {
        const guest = reservation?.guest || {};
        const key = guest.email || guest.phone || guest.name;
        if (!key) return;

        if (!clientMap.has(key)) {
          clientMap.set(key, {
            name: guest.name || "—",
            email: guest.email || "—",
            phone: guest.phone || "—",
            idPhotoFront: guest.idPhotoFront || null,
            idPhotoBack: guest.idPhotoBack || null,
            count: 0
          });
        } else {
          const current = clientMap.get(key);
          if (!current.idPhotoFront && guest.idPhotoFront) current.idPhotoFront = guest.idPhotoFront;
          if (!current.idPhotoBack && guest.idPhotoBack) current.idPhotoBack = guest.idPhotoBack;
        }

        clientMap.get(key).count += 1;
      });

      return Array.from(clientMap.values());
    };

    const renderClients = (clients) => {
      if (!tableBody) return;
      tableBody.innerHTML = "";

      if (!clients.length) {
        tableBody.innerHTML = "<tr><td colspan=\"7\">No hay clientes registrados.</td></tr>";
        return;
      }

      const encodePath = (path) => encodeURIComponent(path || "");

      clients.forEach((client) => {
        const row = document.createElement("tr");
        const frontButton = client.idPhotoFront
          ? `<button class="btn btn-info btn-small" data-action="view-id" data-path="${encodePath(client.idPhotoFront)}">Ver</button>`
          : "—";
        const backButton = client.idPhotoBack
          ? `<button class="btn btn-info btn-small" data-action="view-id" data-path="${encodePath(client.idPhotoBack)}">Ver</button>`
          : "—";
        row.innerHTML = `
          <td>${client.name}</td>
          <td>${client.email}</td>
          <td>${client.phone}</td>
          <td>${client.count}</td>
          <td>${frontButton}</td>
          <td>${backButton}</td>
          <td>
            <button class="btn btn-info btn-small" disabled>Ver</button>
            <button class="btn btn-primary btn-small" disabled>Editar</button>
            <button class="btn btn-danger btn-small" disabled>Eliminar</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    };

    tableBody.addEventListener("click", async (event) => {
      const button = event.target.closest("[data-action='view-id']");
      if (!button) return;
      const path = decodeURIComponent(button.dataset.path || "");
      if (!path) return;

      try {
        const response = await fetch("/api/signed-url", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ bucket: "customer-ids", path })
        });
        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(result?.error || "No se pudo generar el enlace.");
        }
        if (result?.signedUrl) {
          window.open(result.signedUrl, "_blank", "noopener");
        }
      } catch (error) {
        alert(error.message || "Error obteniendo el ID.");
      }
    });

    const fetchReservations = async () => {
      try {
        const response = await fetch("/api/reservations");
        if (!response.ok) return null;
        const result = await response.json();
        return result?.data || null;
      } catch (error) {
        return null;
      }
    };

    const loadClients = async () => {
      const apiReservations = await fetchReservations();
      if (apiReservations && apiReservations.length) {
        renderClients(buildClientMap(apiReservations));
        return;
      }
      renderClients(buildClientMap(readReservations()));
    };

    loadClients();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/admin/js/auth.js"></script>
</body>
</html>
