<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Clientes | Luxury Condo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/clientes.css">
  <link rel="stylesheet" href="css/admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

  <aside class="sidebar">
    <h2>Luxury Condo</h2>
    <nav>
      <a href="admin.html" class="active">Dashboard</a>
      <a href="reservaciones.html">Reservaciones</a>
      <a href="rooms.html">Departamentos</a>
      <a href="avisos.html">Avisos</a>
      <a href="clientes.html">Clientes</a>
      <a href="reportes.html">Reportes</a>

      <a href="index.html" class="logout" data-logout>Cerrar sesión</a>
    </nav>
  </aside>

  <main class="main">

    <header class="header">
      <h1>Clientes</h1>
    </header>

    <section class="table-section">
      <h2>Clientes registrados</h2>

      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Teléfono</th>
            <th>Reservaciones</th>
            <th>Acciones</th>
          </tr>
        </thead>

        <tbody id="clientTableBody">
          <tr>
            <td colspan="5">No hay clientes registrados.</td>
          </tr>
        </tbody>
      </table>
    </section>

  </main>

  <script>
    const STORAGE_KEY = "luxuryReservations";
    const tableBody = document.getElementById("clientTableBody");

    const readReservations = () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (error) {
        return [];
      }
    };

    const normalizeReservation = (reservation) => {
      if (reservation?.guest) return reservation;
      return {
        guest: {
          name: reservation?.guest_name || "—",
          email: reservation?.guest_email || "—",
          phone: reservation?.guest_phone || "—"
        }
      };
    };

    const buildClientMap = (reservationsRaw) => {
      const reservations = reservationsRaw.map(normalizeReservation);
      const clientMap = new Map();

      reservations.forEach((reservation) => {
        const guest = reservation?.guest || {};
        const key = guest.email || guest.phone || guest.name;
        if (!key) return;

        if (!clientMap.has(key)) {
          clientMap.set(key, {
            name: guest.name || "—",
            email: guest.email || "—",
            phone: guest.phone || "—",
            count: 0
          });
        }

        clientMap.get(key).count += 1;
      });

      return Array.from(clientMap.values());
    };

    const renderClients = (clients) => {
      if (!tableBody) return;
      tableBody.innerHTML = "";

      if (!clients.length) {
        tableBody.innerHTML = "<tr><td colspan=\"5\">No hay clientes registrados.</td></tr>";
        return;
      }

      clients.forEach((client) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${client.name}</td>
          <td>${client.email}</td>
          <td>${client.phone}</td>
          <td>${client.count}</td>
          <td>
            <button class="btn btn-info btn-small" disabled>Ver</button>
            <button class="btn btn-primary btn-small" disabled>Editar</button>
            <button class="btn btn-danger btn-small" disabled>Eliminar</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    };

    const fetchReservations = async () => {
      try {
        const response = await fetch("/api/reservations");
        if (!response.ok) return null;
        const result = await response.json();
        return result?.data || null;
      } catch (error) {
        return null;
      }
    };

    const loadClients = async () => {
      const apiReservations = await fetchReservations();
      if (apiReservations && apiReservations.length) {
        renderClients(buildClientMap(apiReservations));
        return;
      }
      renderClients(buildClientMap(readReservations()));
    };

    loadClients();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/admin/js/auth.js"></script>
</body>
</html>
