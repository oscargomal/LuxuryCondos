<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Clientes | Luxury Condo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/clientes.css">
  <link rel="stylesheet" href="css/admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

  <aside class="sidebar">
    <h2>Luxury Condo</h2>
    <nav>
      <a href="admin.html" class="active">Dashboard</a>
      <a href="reservaciones.html">Reservaciones</a>
      <a href="rooms.html">Departamentos</a>
      <a href="avisos.html">Avisos</a>
      <a href="clientes.html">Clientes</a>
      <a href="reportes.html">Reportes</a>

      <a href="index.html" class="logout" data-logout>Cerrar sesión</a>
    </nav>
  </aside>

  <main class="main">

    <header class="header">
      <h1>Clientes</h1>
    </header>

    <section class="table-section">
      <h2>Clientes registrados</h2>

      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Teléfono</th>
            <th>Reservaciones</th>
            <th>Acciones</th>
          </tr>
        </thead>

        <tbody id="clientTableBody">
          <tr>
            <td colspan="5">No hay clientes registrados.</td>
          </tr>
        </tbody>
      </table>
    </section>

  </main>

  <div class="modal-overlay" id="clientModal">
    <div class="modal">
      <button class="modal-close" type="button" data-modal-close>×</button>
      <h3>Detalle del cliente</h3>
      <div class="modal-grid" id="clientModalInfo"></div>
      <div class="modal-actions" id="clientModalIdActions"></div>
      <ul class="modal-list" id="clientModalReservations"></ul>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "luxuryReservations";
    const tableBody = document.getElementById("clientTableBody");
    const modal = document.getElementById("clientModal");
    const modalInfo = document.getElementById("clientModalInfo");
    const modalReservations = document.getElementById("clientModalReservations");
    const modalIdActions = document.getElementById("clientModalIdActions");
    const modalClose = document.querySelector("[data-modal-close]");
    let reservationsCache = [];

    const readReservations = () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (error) {
        return [];
      }
    };

    const normalizeReservation = (reservation) => {
      if (reservation?.guest) return reservation;
      const guestSnapshot = reservation?.guest_snapshot || {};
      return {
        id: reservation?.id,
        guest: {
          name: reservation?.guest_name || guestSnapshot?.name || "—",
          email: reservation?.guest_email || guestSnapshot?.email || "—",
          phone: reservation?.guest_phone || guestSnapshot?.phone || "—",
          idPhotoFront: guestSnapshot?.idPhotoFront || null,
          idPhotoBack: guestSnapshot?.idPhotoBack || null
        },
        stayType: reservation?.stay_type,
        checkin: reservation?.checkin,
        checkout: reservation?.checkout,
        status: reservation?.status,
        paymentStatus: reservation?.payment_status
      };
    };

    const formatStayType = (value) => {
      if (!value) return "—";
      const normalized = String(value).toLowerCase();
      if (normalized === "night") return "Por noche";
      if (normalized === "month") return "Mensual";
      if (normalized === "year") return "Anual";
      if (normalized === "other") return "Otro";
      return value;
    };

    const getPaymentMethodLabel = (reservation) => {
      const stayType = String(reservation?.stayType || "").toLowerCase();
      if (stayType === "other") return "No aplica";
      const status = String(reservation?.status || "").toLowerCase();
      if (status.includes("transfer")) return "Transferencia";
      return "Tarjeta";
    };

    const buildClientMap = (reservationsRaw) => {
      const reservations = reservationsRaw.map(normalizeReservation);
      reservationsCache = reservations;
      const clientMap = new Map();

      reservations.forEach((reservation) => {
        const guest = reservation?.guest || {};
        const key = guest.email || guest.phone || guest.name || String(reservation?.id || "");
        if (!key) return;

        if (!clientMap.has(key)) {
          clientMap.set(key, {
            key,
            name: guest.name || "—",
            email: guest.email || "—",
            phone: guest.phone || "—",
            idPhotoFront: guest.idPhotoFront || null,
            idPhotoBack: guest.idPhotoBack || null,
            count: 0,
            reservations: []
          });
        } else {
          const current = clientMap.get(key);
          if (!current.idPhotoFront && guest.idPhotoFront) current.idPhotoFront = guest.idPhotoFront;
          if (!current.idPhotoBack && guest.idPhotoBack) current.idPhotoBack = guest.idPhotoBack;
        }

        clientMap.get(key).count += 1;
        clientMap.get(key).reservations.push(reservation);
      });

      return Array.from(clientMap.values());
    };

    const renderClients = (clients) => {
      if (!tableBody) return;
      tableBody.innerHTML = "";

      if (!clients.length) {
        tableBody.innerHTML = "<tr><td colspan=\"5\">No hay clientes registrados.</td></tr>";
        return;
      }

      clients.forEach((client) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${client.name}</td>
          <td>${client.email}</td>
          <td>${client.phone}</td>
          <td>${client.count}</td>
          <td>
            <button class="btn btn-info btn-small" data-action="view" data-key="${client.key}">Ver</button>
            <button class="btn btn-primary btn-small" disabled>Editar</button>
            <button class="btn btn-danger btn-small" disabled>Eliminar</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    };

    const fetchSignedUrl = async (path) => {
      const response = await fetch("/api/signed-url", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bucket: "customer-ids", path })
      });
      const result = await response.json().catch(() => ({}));
      if (!response.ok) {
        throw new Error(result?.error || "No se pudo generar el enlace.");
      }
      return result?.signedUrl || "";
    };

    const openClientModal = async (client) => {
      if (!modal || !modalInfo || !modalReservations) return;
      modalInfo.innerHTML = `
        <p><span>Nombre</span>${client.name}</p>
        <p><span>Correo</span>${client.email}</p>
        <p><span>Teléfono</span>${client.phone}</p>
      `;

      modalIdActions.innerHTML = "";
      if (client.idPhotoFront) {
        const btn = document.createElement("button");
        btn.className = "btn btn-info btn-small";
        btn.textContent = "Ver ID frente";
        btn.addEventListener("click", async () => {
          try {
            const url = await fetchSignedUrl(client.idPhotoFront);
            if (url) window.open(url, "_blank", "noopener");
          } catch (error) {
            alert(error.message || "Error obteniendo el ID.");
          }
        });
        modalIdActions.appendChild(btn);
      }

      if (client.idPhotoBack) {
        const btn = document.createElement("button");
        btn.className = "btn btn-info btn-small";
        btn.textContent = "Ver ID reverso";
        btn.addEventListener("click", async () => {
          try {
            const url = await fetchSignedUrl(client.idPhotoBack);
            if (url) window.open(url, "_blank", "noopener");
          } catch (error) {
            alert(error.message || "Error obteniendo el ID.");
          }
        });
        modalIdActions.appendChild(btn);
      }

      if (!client.idPhotoFront && !client.idPhotoBack) {
        const empty = document.createElement("span");
        empty.textContent = "Sin ID registrado.";
        modalIdActions.appendChild(empty);
      }

      modalReservations.innerHTML = "";
      const reservations = client.reservations || [];
      if (!reservations.length) {
        modalReservations.innerHTML = "<li>Sin reservaciones registradas.</li>";
      } else {
        reservations.forEach((reservation) => {
          const stayTypeLabel = formatStayType(reservation.stayType);
          const paymentMethod = getPaymentMethodLabel(reservation);
          const checkin = reservation.checkin || "—";
          const checkout = reservation.checkout || "—";
          const status = reservation.status || "—";
          const item = document.createElement("li");
          item.textContent = `#${reservation.id} · ${stayTypeLabel} · ${checkin} → ${checkout} · ${paymentMethod} · ${status}`;
          modalReservations.appendChild(item);
        });
      }

      modal.classList.add("active");
    };

    tableBody.addEventListener("click", async (event) => {
      const button = event.target.closest("[data-action='view']");
      if (!button) return;
      const key = button.dataset.key;
      const client = buildClientMap(reservationsCache).find((item) => item.key === key);
      if (client) {
        await openClientModal(client);
      }
    });

    if (modalClose && modal) {
      modalClose.addEventListener("click", () => modal.classList.remove("active"));
      modal.addEventListener("click", (event) => {
        if (event.target === modal) modal.classList.remove("active");
      });
    }

    const fetchReservations = async () => {
      try {
        const response = await fetch("/api/reservations");
        if (!response.ok) return null;
        const result = await response.json();
        return result?.data || null;
      } catch (error) {
        return null;
      }
    };

    const loadClients = async () => {
      const apiReservations = await fetchReservations();
      if (apiReservations && apiReservations.length) {
        renderClients(buildClientMap(apiReservations));
        return;
      }
      renderClients(buildClientMap(readReservations()));
    };

    loadClients();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/admin/js/auth.js"></script>
</body>
</html>
