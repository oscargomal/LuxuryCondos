<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reservaciones | Luxury Condo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/reservaciones.css">
  <link rel="stylesheet" href="css/admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

  <aside class="sidebar">
    <h2>Luxury Condo</h2>
    <nav>
      <a href="admin.html" class="active">Dashboard</a>
      <a href="reservaciones.html">Reservaciones</a>
      <a href="rooms.html">Departamentos</a>
      <a href="avisos.html">Avisos</a>
      <a href="clientes.html">Clientes</a>
      <a href="reportes.html">Reportes</a>

      <a href="index.html" class="logout" data-logout>Cerrar sesión</a>
    </nav>
  </aside>

  <main class="main">

    <header class="header">
      <h1>Reservaciones</h1>
    </header>

    <section class="form-card">
      <h2>Filtros</h2>

      <div class="filters">
        <div class="form-group">
          <label>Estado</label>
          <select>
            <option>Todos</option>
            <option>Pendiente</option>
            <option>Confirmada</option>
            <option>Cancelada</option>
          </select>
        </div>

        <div class="form-group">
          <label>Fecha entrada</label>
          <input type="date">
        </div>

        <div class="form-group">
          <label>Fecha salida</label>
          <input type="date">
        </div>

        <button class="btn btn-primary">Buscar</button>
      </div>
    </section>

    <section class="table-section">
      <h2>Listado de reservaciones</h2>

      <table>
        <thead>
          <tr>
            <th>Folio</th>
            <th>Cliente</th>
            <th>Departamento</th>
            <th>Tipo</th>
            <th>Pago</th>
            <th>Entrada</th>
            <th>Salida</th>
            <th>Ocupado</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>

        <tbody id="reservationTableBody">
          <tr>
            <td colspan="10">No hay reservaciones registradas.</td>
          </tr>
        </tbody>
      </table>
    </section>

  </main>

  <script>
    const STORAGE_KEY = "luxuryReservations";
    const tableBody = document.getElementById("reservationTableBody");

    const readReservations = () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (error) {
        return [];
      }
    };

    const getStatusClass = (reservation) => {
      const status = reservation?.status || "";
      const normalized = status.toLowerCase();
      if (reservation?.paymentStatus === "paid" || normalized.includes("confirm")) {
        return "active";
      }
      if (normalized.includes("cancel")) return "canceled";
      return "pending";
    };

    const formatDate = (value) => (value ? value : "—");
    const formatStayType = (value) => {
      if (!value) return "—";
      const normalized = String(value).toLowerCase();
      if (normalized === "night") return "Por noche";
      if (normalized === "month") return "Mensual";
      if (normalized === "year") return "Anual";
      if (normalized === "other") return "Otro";
      return value;
    };

    const getPaymentMethodLabel = (reservation) => {
      const stayType = String(reservation?.stayType || "").toLowerCase();
      if (stayType === "other") return "No aplica";
      const status = String(reservation?.status || "").toLowerCase();
      if (status.includes("transfer")) return "Transferencia";
      return "Tarjeta";
    };

    const normalizeReservation = (reservation) => {
      if (reservation?.guest) return reservation;
      return {
        id: reservation?.id,
        guest: {
          name: reservation?.guest_name || "—",
          email: reservation?.guest_email || "—",
          phone: reservation?.guest_phone || "—"
        },
        room: {
          name: reservation?.room_name || "—"
        },
        stayType: reservation?.stay_type,
        checkin: reservation?.checkin,
        checkout: reservation?.checkout,
        total: reservation?.total,
        status: reservation?.status,
        paymentStatus: reservation?.payment_status,
        roomOccupied: reservation?.room_occupied
      };
    };

    const renderTable = (reservations) => {
      if (!tableBody) return;
      tableBody.innerHTML = "";

      if (!reservations.length) {
        tableBody.innerHTML = "<tr><td colspan=\"10\">No hay reservaciones registradas.</td></tr>";
        return;
      }

      reservations.forEach((reservationRaw) => {
        const reservation = normalizeReservation(reservationRaw);
        const row = document.createElement("tr");
        const guestName = reservation?.guest?.name || "—";
        const roomName = reservation?.room?.name
          || (reservation?.stayType === "other" ? "Otro" : "—");
        const status = reservation?.status || "Pendiente de pago";
        const statusClass = getStatusClass(reservation);
        const occupiedValue = reservation?.roomOccupied ?? (reservation?.paymentStatus === "paid");
        const occupiedLabel = occupiedValue ? "Sí" : "No";
        const stayTypeLabel = formatStayType(reservation?.stayType);
        const paymentMethodLabel = getPaymentMethodLabel(reservation);
        const canConfirmTransfer = paymentMethodLabel === "Transferencia"
          && reservation?.paymentStatus !== "paid"
          && !String(reservation?.status || "").toLowerCase().includes("confirm");

        row.innerHTML = `
          <td>${reservation?.id || "—"}</td>
          <td>${guestName}</td>
          <td>${roomName}</td>
          <td>${stayTypeLabel}</td>
          <td>${paymentMethodLabel}</td>
          <td>${formatDate(reservation.checkin)}</td>
          <td>${formatDate(reservation.checkout)}</td>
          <td>${occupiedLabel}</td>
          <td class="status ${statusClass}">${status}</td>
          <td>
            ${canConfirmTransfer
              ? `<button class="btn btn-success btn-small" data-action="confirm-transfer" data-id="${reservation.id}">Confirmar</button>`
              : ""}
            <button class="btn btn-danger btn-small" data-action="delete" data-id="${reservation.id}">Eliminar</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    };

    tableBody.addEventListener("click", async (event) => {
      const button = event.target.closest("[data-action]");
      if (!button) return;

      if (button.dataset.action === "delete") {
        const id = button.dataset.id;
        const shouldDelete = confirm("¿Seguro que deseas eliminar esta reservación?");
        if (!shouldDelete) return;
        try {
          await fetch("/api/reservations", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id })
          });
        } catch (error) {
          // Mantener respaldo local si falla el API.
        }
        const nextReservations = readReservations().filter(item => String(item.id) !== String(id));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(nextReservations));
        renderTable(nextReservations);
      }

      if (button.dataset.action === "confirm-transfer") {
        const id = button.dataset.id;
        const shouldConfirm = confirm("¿Confirmar pago por transferencia?");
        if (!shouldConfirm) return;
        try {
          const response = await fetch("/api/reservations", {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id,
              status: "Confirmada",
              paymentStatus: "paid",
              roomOccupied: 1
            })
          });
          if (!response.ok) {
            const result = await response.json().catch(() => ({}));
            throw new Error(result?.error || "No se pudo confirmar.");
          }
          loadReservations();
        } catch (error) {
          alert(error.message || "Error confirmando la transferencia.");
        }
      }
    });

    const fetchReservations = async () => {
      try {
        const response = await fetch("/api/reservations");
        if (!response.ok) return null;
        const result = await response.json();
        return result?.data || null;
      } catch (error) {
        return null;
      }
    };

    const loadReservations = async () => {
      const apiReservations = await fetchReservations();
      if (apiReservations && apiReservations.length) {
        renderTable(apiReservations);
        return;
      }
      renderTable(readReservations());
    };

    loadReservations();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/admin/js/auth.js"></script>
</body>
</html>
